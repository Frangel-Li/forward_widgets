name: Sync FWD 18+

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
<<<<<<< HEAD
      # 1. Checkout repo (ä¸å˜)
      - name: Checkout repo
=======
      - name: Checkout repository
>>>>>>> bfa56cf8399e184018722d448f1cae5b2edb92f9
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_FOR_ACTIONS }}

<<<<<<< HEAD
      # 2. åˆ›å»ºç›®å½• (ä¸å˜)
      - name: Create directory for widgets
        run: mkdir -p ./forward_widgets

      # 3. ä¸‹è½½æ–‡ä»¶ (ä¸å˜)
      - name: Download FWD files
        run: |
          # ç¡®ä¿è¿™é‡Œçš„é“¾æ¥æ˜¯ä½ æ‰¾åˆ°çš„æœ€æ–°ã€æ­£ç¡®çš„é“¾æ¥
          curl -L -o ./fwd_sources/emryschoo.fwd 'https://raw.githubusercontent.com/pack1r/ForwardWidgets/refs/heads/main/pack1r-18.fwd'

      # 4. ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿å’Œ jq è¿›è¡Œæ™ºèƒ½åˆå¹¶
      - name: Merge FWD files with custom template
        id: merge
        run: |
          # ã€å·²ä¿®æ”¹ã€‘è¾“å‡ºæ–‡ä»¶åæ”¹ä¸º Ethan_widgets_18.fwd
          OUTPUT_FILE="Ethan_widgets_18.fwd"
          
          # æ£€æŸ¥ jq æ˜¯å¦å®‰è£…
          if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
          fi

          # æ­¥éª¤ä¸€ï¼šç°åœºåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åŸºç¡€æ¨¡æ¿æ–‡ä»¶
          cat <<'EOF' > base_template.json
          {
            "title": "Ethan's Widgets",
            "description": "A collection of widgets created by Ethan",
            "icon": "https://github.com/pack1r/ForwardWidgets/raw/main/icon.png",
            "widgets": []
          }
          EOF
          
          # æ­¥éª¤äºŒï¼šä»æ‰€æœ‰ä¸‹è½½çš„ .fwd æ–‡ä»¶ä¸­æå– widgetsï¼Œåˆå¹¶å¹¶å»é‡
          jq -s 'map(.widgets) | add | unique' ./forward_widgets/*.fwd > widgets_only.json

          # æ­¥éª¤ä¸‰ï¼šå°†åˆå¹¶å¥½çš„ widgets æ•°ç»„æ³¨å…¥åˆ°æˆ‘ä»¬åˆ›å»ºçš„åŸºç¡€æ¨¡æ¿ä¸­
          jq --argfile widgets widgets_only.json '.widgets = $widgets' base_template.json > "$OUTPUT_FILE"

          echo "JSON merge complete. Output file is $OUTPUT_FILE."
          
      # 5. æäº¤å¹¶æ¨é€å˜æ›´ (ä¸å˜)
      - name: Commit and push if changed
=======
      - name: Create source directory
        run: mkdir -p ./fwd_sources

      - name: Download FWD files
        run: |
          curl -L --fail -o ./fwd_sources/emryschoo.fwd 'https://raw.githubusercontent.com/pack1r/ForwardWidgets/refs/heads/main/pack1r-18.fwd'

      - name: Extract widgets from possibly invalid JSON
        run: |
          echo "[" > combined_widgets.json

          first=1
          for file in ./fwd_sources/*.fwd; do
            echo "ğŸ” æ­£åœ¨å¤„ç† $file"

            # æå– widgets æ•°ç»„ä¸»ä½“ï¼Œå¿½ç•¥ widgets: å¼€å¤´å’Œç»“å°¾ ]
            widgets=$(sed -n '/"widgets"[[:space:]]*:/,/]/p' "$file" | sed '1d;$d')

            # åˆ é™¤ widgets å—ä¸­æœ€åä¸€ä¸ªå¯¹è±¡åå¤šä½™çš„é€—å·
            widgets=$(echo "$widgets" | sed ':a;N;$!ba;s/},[[:space:]]*$/}/')

            if [ -n "$widgets" ]; then
              if [ $first -eq 0 ]; then
                echo "," >> combined_widgets.json
              fi
              echo "$widgets" >> combined_widgets.json
              first=0
            else
              echo "âš ï¸ è·³è¿‡æ— æ•ˆæˆ–æ—  widgets çš„æ–‡ä»¶ï¼š$file"
            fi
          done

          echo "]" >> combined_widgets.json

          # å»é‡ï¼ˆæŒ‰ idï¼‰
          jq 'unique_by(.title)' combined_widgets.json > final_widgets.json

      - name: Build final Ethan_widgets_18.fwd
        run: |
          {
            echo '{'
            echo '  "title": "Ethan'\''s Widgets",'
            echo '  "description": "A collection of widgets created by Ethan",'
            echo '  "icon": "https://github.com/pack1r/ForwardWidgets/raw/main/icon.png",'
            echo '  "widgets":'
            cat final_widgets.json
            echo '}'
          } > Ethan_widgets_18.fwd

      - name: Backup old version
        run: |
          mkdir -p fwd_history
          timestamp=$(date +%Y%m%d_%H%M%S)
          cp Ethan_widgets_18.fwd "fwd_history/Ethan_widgets_18_$timestamp.fwd"
          echo "timestamp=$timestamp" >> $GITHUB_ENV

      - name: Commit and push changes
>>>>>>> bfa56cf8399e184018722d448f1cae5b2edb92f9
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Ethan_widgets_18.fwd fwd_history/
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit."
            exit 0
          fi
<<<<<<< HEAD
          git commit -m "chore: auto-sync and merge FWD files"
          git push
=======
          git commit -m "chore: auto-merge widgets @ ${{ env.timestamp }}"
          git push
>>>>>>> bfa56cf8399e184018722d448f1cae5b2edb92f9
