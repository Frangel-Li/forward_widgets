name: Sync FWD Files

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_FOR_ACTIONS }}

      - name: Create directory for downloaded files
        run: mkdir -p ./fwd_sources

      - name: Download the source files
        run: |
          curl -L --fail -o ./fwd_sources/pack1r.fwd 'https://github.com/pack1r/ForwardWidgets/raw/main/pack1r.fwd'
          curl -L --fail -o ./fwd_sources/huangxd.fwd 'https://raw.githubusercontent.com/huangxd-/ForwardWidgets/main/widgets.fwd'
          curl -L --fail -o ./fwd_sources/emryschoo.fwd 'https://github.com/EmrysChoo/ForwardWidgets/raw/main/person_Widgets.fwd'

      - name: Prepare base template
        run: |
          cat <<'EOF' > base_template.json
          {
            "title": "Ethan's Widgets",
            "description": "A collection of widgets created by Ethan",
            "icon": "https://github.com/pack1r/ForwardWidgets/raw/main/icon.png",
            "widgets": []
          }
          EOF

      - name: Merge all .fwd widgets & generate output
        id: merge
        run: |
          OUTPUT_FILE="Ethan_widgets.fwd"

          # åˆå¹¶æ‰€æœ‰ widgetsï¼Œå»é‡
          jq -s 'map(.widgets) | flatten | unique_by(.id)' ./fwd_sources/*.fwd > final_widgets.json

          # æ³¨å…¥æ¨¡æ¿ä¸­
          jq --argfile widgets final_widgets.json '.widgets = $widgets' base_template.json > "$OUTPUT_FILE"

          # å¤‡ä»½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "$OUTPUT_FILE" ]; then
            mkdir -p fwd_history
            timestamp=$(date +%Y%m%d_%H%M%S)
            cp "$OUTPUT_FILE" "fwd_history/Ethan_widgets_$timestamp.fwd"
          fi

          echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV

      - name: Compare new widgets and generate changelog
        run: |
          touch old_widgets.json
          jq '.widgets | sort_by(.id)' Ethan_widgets.fwd 2>/dev/null || echo '[]' > old_widgets.json
          jq '.widgets | sort_by(.id)' final_widgets.json > new_widgets.json

          # æå–æ–°å¢çš„ widget id
          jq -n --slurpfile old old_widgets.json --slurpfile new new_widgets.json \
            '$new - $old | map(.id)' > added_ids.json

          echo "ğŸ“ æ–°å¢ Widgets ID:" > CHANGELOG.md
          jq -r '.[]' added_ids.json >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Ethan_widgets.fwd CHANGELOG.md fwd_history/
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: auto-sync FWD files @ ${{ env.timestamp }}"
          git push

      #ï¼ˆå¯é€‰ï¼‰æ¨é€æ‰€æœ‰å†å²æ–‡ä»¶åˆ° history åˆ†æ”¯
      # - name: Push to history branch
      #   run: |
      #     git checkout -b history
      #     git add fwd_history/
      #     git commit -m "chore: backup @ ${{ env.timestamp }}"
      #     git push origin history --force
