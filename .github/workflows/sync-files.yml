name: Sync FWD Files

on:
  schedule:
    # 每天定时执行一次 (UTC时间0点，大概是北京时间早上8点)
    - cron: '0 0 * * *'
  # 允许你手动在 Actions 页面点击按钮触发
  workflow_dispatch:


jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repo (不变)
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_FOR_ACTIONS }}

      # 2. 创建目录 (不变)
      - name: Create directory for widgets
        run: mkdir -p ./forward_widgets

      # 3. 下载文件 (不变)
      - name: Download FWD files
        run: |
          curl -L -o ./forward_widgets/pack1r.fwd 'https://github.com/pack1r/ForwardWidgets/raw/main/pack1r.fwd'
          curl -L -o ./forward_widgets/huangxd.fwd 'https://raw.githubusercontent.com/huangxd-/ForwardWidgets/main/widgets.fwd'
          curl -L -o ./forward_widgets/emryschoo.fwd 'https://github.com/EmrysChoo/ForwardWidgets/raw/main/person_Widgets.fwd'

      # 4. 【新增步骤】验证所有下载文件的JSON语法
      - name: Validate JSON syntax of each FWD file
        run: |
          echo "--- Validating downloaded files ---"
          for file in ./forward_widgets/*.fwd; do
            echo "Validating $file..."
            # 尝试用 jq 解析文件，如果失败就报错并打印文件内容
            if jq -e . "$file" > /dev/null; then
              echo "$file syntax is OK."
            else
              echo "!!! ERROR: Invalid JSON in $file !!!"
              echo "--- File Content Start ---"
              cat "$file"
              echo "--- File Content End ---"
              exit 1 # 立刻退出，让整个 Action 失败
            fi
          done
          echo "--- All files are valid JSON ---"

      # 5. 使用自定义模板和 jq 进行智能合并 (原第4步)
      - name: Merge FWD files with custom template
        id: merge
        run: |
          OUTPUT_FILE="Ethan_widgets.fwd"
          
          cat <<'EOF' > base_template.json
          {
            "title": "Ethan's Widgets",
            "description": "A collection of widgets created by Ethan",
            "icon": "https://github.com/pack1r/ForwardWidgets/raw/main/icon.png",
            "widgets": []
          }
          EOF
          
          jq -s 'map(.widgets) | add | unique' ./forward_widgets/*.fwd > widgets_only.json

          jq --argfile widgets widgets_only.json '.widgets = $widgets' base_template.json > "$OUTPUT_FILE"

          echo "JSON merge complete. Output file is $OUTPUT_FILE."
          
      # 6. 提交并推送变更 (原第5步)
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: auto-sync and merge FWD files"
          git push
